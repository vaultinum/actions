name: CI

on:
    workflow_call:
        inputs:
            run_npm_install:
                default: false
                type: boolean
            run_eslint:
                default: true
                type: boolean
            run_build:
                default: true
                type: boolean
            run_build_mode:
                type: string
                description: "The mode to run the build. Can be 'node' or 'bun'. Default is 'node'."
                default: "node"
            run_tests:
                default: false
                type: boolean
            brand:
                type: string
                description: Brand to use for the package
            working-directory:
                type: string
                description: The working directory for the job
                default: "."
        secrets:
            NPM_PACKAGE_ACCESS:
                required: true
            GH_TOKEN:
                required: true
            SONAR_TOKEN:
                required: true
            SONAR_URL:
                required: true
            # Additional optional secrets that can be passed from calling workflow
            LIBRARIES_IO_API_KEY:
                required: false
            SONATYPE_USER:
                required: false
            SONATYPE_PASSWORD:
                required: false

concurrency:
    group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}${{ inputs.brand }}
    cancel-in-progress: true

jobs:
    ci:
        runs-on: ubuntu-latest
        outputs:
            message: ${{ steps.commit-message.outputs.message }}
        timeout-minutes: 20
        env:
            NPM_PACKAGE_ACCESS: ${{ secrets.NPM_PACKAGE_ACCESS }}
            NODE_AUTH_TOKEN: ${{ secrets.GH_TOKEN }}
            # Optional secrets - only set if provided
            LIBRARIES_IO_API_KEY: ${{ secrets.LIBRARIES_IO_API_KEY }}
            SONATYPE_USER: ${{ secrets.SONATYPE_USER }}
            SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        steps:
            - name: Checkout Current Repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.sha }}
            - name: Setup Node
              if: ${{ inputs.run_build_mode == 'node' }}
              uses: actions/setup-node@v4
              with:
                  node-version: 22.21.0
            - name: Setup Bun
              if: ${{ inputs.run_build_mode == 'bun' }}
              uses: oven-sh/setup-bun@v2
            - name: Trigger ci
              uses: vaultinum/actions/ci@39
              with:
                  run_npm_install: ${{ inputs.run_npm_install }}
                  run_eslint: ${{ inputs.run_eslint }}
                  run_build: ${{ inputs.run_build }}
                  run_build_mode: ${{ inputs.run_build_mode }}
                  run_tests: ${{ inputs.run_tests }}
                  brand: ${{ inputs.brand }}
                  working-directory: ${{ inputs.working-directory }}
            - name: Get Last Commit Message
              id: commit-message
              run: echo "message=$(git log -1 --pretty=%B HEAD | tr -d '\n')" >> $GITHUB_OUTPUT
    sonarqube:
        if: ${{ inputs.run_tests != true && !contains(needs.ci.outputs.message, '[skip builds]')  }}
        needs: ci
        uses: ./.github/workflows/sonarqube.yaml
        secrets: inherit
        with:
            working-directory: ${{ inputs.working-directory }}
    sonarqube-with-coverage:
        if: ${{ inputs.run_tests == true && !contains(needs.ci.outputs.message, '[skip builds]') }}
        needs: ci
        uses: ./.github/workflows/sonarqube.yaml
        secrets: inherit
        with:
            run_tests: ${{ inputs.run_tests }}
            working-directory: ${{ inputs.working-directory }}
    labeler:
        uses: ./.github/workflows/labeler.yaml
        secrets: inherit
